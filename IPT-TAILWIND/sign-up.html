<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Herdoza Fitness Center - Sign Up</title>
    <link rel="icon" type="image" href="./assets/herdoza-logo-trans.png" />
    <link rel="stylesheet" href="./src/output.css" />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css"
    />
    <link rel="stylesheet" href="./src/mystyles.css" />
    <script type="module" src="./scripts/auth-api.js"></script>
    <style>
      /* Background styles */
      body {
        background-image: linear-gradient(
            to bottom,
            rgba(255, 255, 255, 0.1),
            rgba(0, 0, 0, 0.7)
          ),
          url("./assets/Herdoza-background.jpg");
        background-size: cover;
        background-position: center;
        background-repeat: no-repeat;
        background-attachment: fixed;
      }

      /* Force input text color */
      input[type="text"],
      input[type="email"],
      input[type="tel"],
      input[type="password"],
      input[type="number"] {
        color: black !important;
        background-color: white !important;
      }

      /* Force input text color for PIN input in all browsers */
      #pin,
      #pin.otp-input,
      input#pin[type="number"] {
        color: #111 !important;
        background: #fff !important;
        -webkit-text-fill-color: #111 !important;
        caret-color: #111 !important;
      }
      #pin:-webkit-autofill,
      #pin:-webkit-autofill:focus,
      #pin:-webkit-autofill:hover {
        -webkit-text-fill-color: #111 !important;
        box-shadow: 0 0 0 1000px #fff inset !important;
        background: #fff !important;
        color: #111 !important;
      }
      .modal-content input#pin[type="number"] {
        color: #111 !important;
        background: #fff !important;
      }
      .otp-input {
        color: #111 !important;
        background: #fff !important;
      }

      /* Toast Notification Styles */
      .toast-notification {
        position: fixed;
        top: 1.5rem;
        left: 50%;
        transform: translateX(-50%);
        padding: 1rem 1.5rem;
        border-radius: 8px;
        background-color: #22c55e;
        color: white;
        font-weight: 500;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        z-index: 9999;
        opacity: 0;
        animation: fadeInOut 3s ease forwards;
      }

      @keyframes fadeInOut {
        0% {
          opacity: 0;
          transform: translate(-50%, -100%);
        }
        15% {
          opacity: 1;
          transform: translate(-50%, 0);
        }
        85% {
          opacity: 1;
          transform: translate(-50%, 0);
        }
        100% {
          opacity: 0;
          transform: translate(-50%, -100%);
        }
      }

      .checkbox-error {
        border: 2px solid red;
        border-radius: 4px;
        animation: pulse 1s infinite;
      }

      @keyframes pulse {
        0% {
          box-shadow: 0 0 0 0 rgba(255, 0, 0, 0.4);
        }
        70% {
          box-shadow: 0 0 0 5px rgba(255, 0, 0, 0);
        }
        100% {
          box-shadow: 0 0 0 0 rgba(255, 0, 0, 0);
        }
      }

      /* OTP Modal Styles */
      .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100vh;
        background-color: rgba(0, 0, 0, 0.7);
        z-index: 9999;
      }

      .modal.show {
        display: flex !important;
        align-items: center;
        justify-content: center;
      }

      .modal-content {
        background-color: #1a1a1a;
        padding: 2rem;
        border-radius: 0.5rem;
        width: 90%;
        max-width: 400px;
        border: 1px solid #333;
        animation: modalFadeIn 0.3s;
      }

      @keyframes modalFadeIn {
        from {
          opacity: 0;
          transform: translateY(-20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .otp-input {
        letter-spacing: 0.5em;
        text-align: center;
        font-family: monospace;
        font-size: 1.5em;
      }

      /* Background styles */
      body {
        background-image: linear-gradient(
            to bottom,
            rgba(255, 255, 255, 0.1),
            rgba(0, 0, 0, 0.7)
          ),
          url("./assets/Herdoza-background.jpg");
        background-size: cover;
        background-position: center;
        background-repeat: no-repeat;
        background-attachment: fixed;
      }

      /* Add lighter semi-transparent overlay */
      .bg-overlay {
        background: linear-gradient(
          135deg,
          rgba(255, 255, 255, 0.1) 0%,
          rgba(0, 0, 0, 0.6) 100%
        );
        backdrop-filter: blur(2px);
        min-height: 100vh;
        width: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 1rem;
      }
    </style>
  </head>
  <body class="flex items-center justify-center min-h-screen text-white">
    <div
      class="flex flex-col md:flex-row bg-black-3 w-full max-w-4xl rounded-lg overflow-hidden shadow-lg js-create-acc"
    >
      <div
        class="flex flex-col items-center justify-center p-8 w-full md:w-1/2"
      >
        <div class="flex items-center mb-5">
          <img src="./assets/herdoza-logo-trans.png" alt="Logo" class="h-12" />
          <div class="orbitron font-bold text-sm ms-2">
            HERDOZA FITNESS CENTER
          </div>
        </div>

        <form id="signupForm" class="flex flex-col w-full">
          <div class="text-3xl font-bold mb-6 text-center">Sign Up</div>

          <div class="grid grid-cols-2 gap-4 mb-4">
            <div>
              <label for="firstName" class="text-sm text-white"
                >First Name</label
              >
              <input
                type="text"
                id="firstName"
                required
                placeholder="Juan"
                class="border border-gray-300 rounded-md w-full bg-white p-2 text-sm mt-1 focus:outline-none focus:ring-2 focus:ring-red-600 text-black"
              />
            </div>

            <div>
              <label for="lastName" class="text-sm text-white">Last Name</label>
              <input
                type="text"
                id="lastName"
                required
                placeholder="Dela Cruz"
                class="border border-gray-300 rounded-md w-full bg-white p-2 text-sm mt-1 focus:outline-none focus:ring-2 focus:ring-red-600 text-black"
              />
            </div>
          </div>

          <div class="mb-4">
            <label for="email" class="block text-sm text-white">Email</label>
            <input
              type="email"
              id="email"
              required
              placeholder="example@gmail.com"
              class="border border-gray-300 rounded-md w-full bg-white p-2 text-sm mt-1 focus:outline-none focus:ring-2 focus:ring-red-600 text-black"
              style="max-width: 100%; overflow: hidden; text-overflow: ellipsis"
            />
          </div>

          <div class="mb-4">
            <label for="contactNumber" class="text-sm text-white"
              >Contact Number</label
            >
            <input
              type="tel"
              id="contactNumber"
              required
              placeholder="+63 912 345 6789"
              class="border border-gray-300 rounded-md w-full bg-white p-2 text-sm mt-1 focus:outline-none focus:ring-2 focus:ring-red-600 text-black"
            />
          </div>

          <div class="mb-4">
            <label for="password" class="text-sm text-white">Password</label>
            <div class="relative">
              <input
                type="password"
                id="password"
                placeholder="Enter your password"
                required
                class="border border-gray-300 rounded-md w-full bg-white p-2 pr-10 text-sm mt-1 focus:outline-none focus:ring-2 focus:ring-red-600 text-black"
              />
              <button
                type="button"
                onclick="togglePasswordVisibility('password')"
                class="absolute top-0 right-0 h-full px-3 flex items-center justify-center"
                style="color: black !important"
              >
                <i
                  id="password-toggle-icon"
                  class="bi bi-eye-slash"
                  style="color: black !important"
                ></i>
              </button>
            </div>
            <p class="text-gray-400 text-xs mt-1">
              Must be at least 8 characters long
            </p>
          </div>

          <div class="mb-4">
            <label for="confirm-password" class="text-sm text-white"
              >Confirm Password</label
            >
            <div class="relative">
              <input
                type="password"
                id="confirm-password"
                placeholder="Re-enter your password"
                required
                class="border border-gray-300 rounded-md w-full bg-white p-2 pr-10 text-sm mt-1 focus:outline-none focus:ring-2 focus:ring-red-600 text-black"
              />
              <button
                type="button"
                onclick="togglePasswordVisibility('confirm-password')"
                class="absolute top-0 right-0 h-full px-3 flex items-center justify-center"
                style="color: black !important"
              >
                <i
                  id="confirm-password-toggle-icon"
                  class="bi bi-eye-slash"
                  style="color: black !important"
                ></i>
              </button>
            </div>
            <p class="text-gray-400 text-xs mt-1">
              Re-enter your password to confirm
            </p>
          </div>

          <div class="flex items-center text-xs mb-2">
            <div class="flex items-center" id="terms-checkbox-container">
              <input type="checkbox" id="agreeTerms" class="mr-2" required />
              <label for="agreeTerms">I Agree With Herdoza's Gym Fitness</label>
            </div>
            <a href="privacy-policy.html" class="text-red-500 ms-auto"
              ><u>Privacy Policy</u></a
            >
          </div>
          <div id="checkbox-error" class="text-red-500 text-xs mb-3 hidden">
            You must agree to the terms and privacy policy.
          </div>

          <div id="signup-error" class="text-red-500 text-sm mb-4 hidden"></div>

          <button
            type="submit"
            class="bg-red-600 px-6 py-2 rounded-lg hover:bg-red-700 transition text-white w-full text-lg js-signup-btn"
          >
            Create Account
          </button>
        </form>
      </div>

      <div
        class="bg-red-600 text-center flex flex-col justify-center items-center p-8 w-full md:w-1/2 lg:rounded-l-4xl"
      >
        <div class="mb-5 text-2xl font-bold">Welcome to Our Gym!</div>
        <div class="text-sm mb-4">Already have an account?</div>
        <a
          href="login.html"
          class="border border-white text-lg font-bold px-6 py-2 rounded-lg hover:bg-white hover:text-black transition"
        >
          Login
        </a>
      </div>
    </div>

    <!-- Pin Verification Modal -->
    <div id="pinVerificationModal" class="modal">
      <div class="modal-content">
        <h2 class="text-xl font-bold mb-4 text-center text-white">
          Pin Verification
        </h2>
        <p class="text-sm text-gray-400 mb-4 text-center">
          Enter the 4-digit pin to verify your identity
        </p>
        <input
          type="number"
          id="pin"
          class="w-full px-4 py-3 text-center text-2xl tracking-widest font-mono bg-white text-black border border-gray-700 rounded-md focus:ring-2 focus:ring-red-500 focus:border-red-500 mb-4 otp-input"
          placeholder="Enter PIN"
          style="color: black !important; background-color: white !important"
          min="0"
          max="9999"
          oninput="if(this.value.length > 4) this.value=this.value.slice(0,4)"
        />
        <div id="pinError" class="text-red-500 text-sm mb-4 hidden"></div>
        <div class="flex gap-2">
          <button
            id="verifyPin"
            class="bg-red-600 flex-1 py-2 rounded-lg hover:bg-red-700 transition text-white font-bold"
          >
            Verify PIN
          </button>
          <button
            onclick="closePinVerificationModal()"
            class="bg-gray-600 flex-1 py-2 rounded-lg hover:bg-gray-700 transition text-white font-bold"
          >
            Cancel
          </button>
        </div>
      </div>
    </div>

    <!-- Import scripts -->
    <script type="module" src="./scripts/config.js"></script>
    <script type="module" src="./scripts/api-client.js"></script>
    <script type="module" src="./scripts/auth-api.js"></script>
    <script>
      // PIN Verification Modal Functions
      function openPinVerificationModal() {
        const modal = document.getElementById("pinVerificationModal");
        modal.classList.add("show");
      }

      function closePinVerificationModal() {
        const modal = document.getElementById("pinVerificationModal");
        modal.classList.remove("show");
        document.getElementById("pin").value = "";
        document.getElementById("pinError").classList.add("hidden");
      }

      function generatePIN() {
        return Math.floor(1000 + Math.random() * 9000);
      }

      function showError(message) {
        const errorDiv = document.getElementById("pinError");
        errorDiv.textContent = message;
        errorDiv.classList.remove("hidden");
      }

      function showToast(message, type = "success") {
        const toast = document.createElement("div");
        const baseClasses = "toast-notification flex items-center gap-2";
        toast.className = `${baseClasses} ${
          type === "success" ? "bg-green-500" : "bg-red-500"
        }`;
        toast.innerHTML = `
          <i class="bi bi-${
            type === "success" ? "check-circle" : "exclamation-circle"
          } text-xl"></i>
          <span>${message}</span>
        `;
        document.body.appendChild(toast);

        setTimeout(() => {
          toast.remove();
        }, 3000);
      }

      // Handle PIN verification
      document
        .getElementById("verifyPin")
        .addEventListener("click", function () {
          const pin = document.getElementById("pin").value;
          const email = document.getElementById("email").value.toLowerCase();
          const registrations = JSON.parse(
            localStorage.getItem("registrations") || "[]"
          );

          const registration = registrations.find(
            (r) => r.email.toLowerCase() === email
          );

          if (!registration) {
            showError("Registration not found");
            return;
          }

          if (pin === registration.pin.toString()) {
            // Update registration to verified
            registration.verified = true;

            // Initialize empty bookings arrays first with user email
            const storagePrefix = `_${email}`;
            const emptyBookings = {
              mmaPerSession: [],
              mmaBulkSession: [],
              mmaZumba: [],
              zumba: [],
              studio: [],
              gym: [],
            };

            // Save empty bookings to storage with user email
            localStorage.setItem(
              `mmaPerSessionBookings${storagePrefix}`,
              JSON.stringify(emptyBookings.mmaPerSession)
            );
            localStorage.setItem(
              `mma25SessionUserBookings${storagePrefix}`,
              JSON.stringify(emptyBookings.mmaBulkSession)
            );
            localStorage.setItem(
              `mmaZumbaBookings${storagePrefix}`,
              JSON.stringify(emptyBookings.mmaZumba)
            );
            localStorage.setItem(
              `zumbaBookings${storagePrefix}`,
              JSON.stringify(emptyBookings.zumba)
            );
            localStorage.setItem(
              `smallStudioBookings${storagePrefix}`,
              JSON.stringify(emptyBookings.studio)
            );
            localStorage.setItem(
              `largeStudioBookings${storagePrefix}`,
              JSON.stringify(emptyBookings.studio)
            );
            localStorage.setItem(
              `gymBookings${storagePrefix}`,
              JSON.stringify(emptyBookings.gym)
            );

            // Move to members and store user data
            const members = JSON.parse(localStorage.getItem("members") || "[]");
            const { pin, verified, ...memberData } = registration;
            members.push(memberData);
            localStorage.setItem("members", JSON.stringify(members));

            // Store user session data
            localStorage.setItem("userToken", `user-session-${Date.now()}`);
            localStorage.setItem("userEmail", memberData.email);
            localStorage.setItem(
              "userName",
              `${memberData.firstName} ${memberData.lastName}`
            );
            localStorage.setItem("userContact", memberData.contactNumber);

            // Remove from registrations
            const updatedRegistrations = registrations.filter(
              (r) => r.email.toLowerCase() !== email
            );
            localStorage.setItem(
              "registrations",
              JSON.stringify(updatedRegistrations)
            );
            // Show success message and redirect
            showToast("Registration successful! Redirecting to Home...");
            setTimeout(() => {
              window.location.href = "index.html";
            }, 2000);
          } else {
            showError("Invalid PIN");
          }
        });

      // Password visibility toggle
      window.togglePasswordVisibility = function (fieldId) {
        const passwordField = document.getElementById(fieldId);
        const toggleIcon = document.getElementById(`${fieldId}-toggle-icon`);
        if (passwordField.type === "password") {
          passwordField.type = "text";
          toggleIcon.classList.remove("bi-eye-slash");
          toggleIcon.classList.add("bi-eye");
        } else {
          passwordField.type = "password";
          toggleIcon.classList.remove("bi-eye");
          toggleIcon.classList.add("bi-eye-slash");
        }
      };
    </script>

    <script type="module">
      document.addEventListener("DOMContentLoaded", function () {
        const form = document.getElementById("signupForm");

        if (form) {
          form.addEventListener("submit", async function (e) {
            e.preventDefault();

            const errorElement = document.getElementById("signup-error");
            errorElement.classList.add("hidden");

            // Validate form fields first
            const password = document.getElementById("password").value;
            const confirmPassword =
              document.getElementById("confirm-password").value;
            const firstName = document.getElementById("firstName").value;
            const lastName = document.getElementById("lastName").value;
            const email = document
              .getElementById("email")
              .value.trim()
              .toLowerCase();
            const contact = document.getElementById("contactNumber").value;

            // Validate passwords match
            if (password !== confirmPassword) {
              errorElement.textContent = "Passwords do not match";
              errorElement.classList.remove("hidden");
              return;
            }

            // Validate terms agreement
            const agreeTerms = document.getElementById("agreeTerms");
            if (!agreeTerms.checked) {
              document
                .getElementById("checkbox-error")
                .classList.remove("hidden");
              document
                .getElementById("terms-checkbox-container")
                .classList.add("checkbox-error");
              return;
            }

            // Initialize new user data
            const userData = {
              id: Date.now().toString(),
              email,
              firstName,
              lastName,
              password,
              contactNumber: contact,
              type: "Gym Fitness",
              membershipDuration: "1",
              paymentMethod: "Cash",
              status: "pending",
              timestamp: new Date().toISOString(),
              paymentStatus: "pending",
              schedules: {
                mmaPerSession: [],
                mmaBulkSession: [],
                mmaZumba: [],
                zumba: [],
                studio: [],
                gym: [],
              },
            };

            // Check email against all possible sources
            if (email === "admin@herdoza-fitness.com") {
              errorElement.textContent =
                "This email cannot be used for registration.";
              errorElement.classList.remove("hidden");
              return;
            }

            // Get existing data
            const registrations = JSON.parse(
              localStorage.getItem("registrations") || "[]"
            );
            const members = JSON.parse(localStorage.getItem("members") || "[]");

            // Case-insensitive email checks
            const existingRegistration = registrations.find(
              (r) => r.email.toLowerCase() === email
            );
            const existingMember = members.find(
              (m) => m.email.toLowerCase() === email
            );

            if (existingRegistration || existingMember) {
              errorElement.textContent =
                "Email already registered. Please use a different email.";
              errorElement.classList.remove("hidden");
              return;
            }

            // If we get here, email is unique - proceed with registration
            try {
              // Generate verification PIN and add to user data
              const verificationPin = generatePIN();
              const registrationData = {
                id: Date.now().toString(),
                name: `${firstName} ${lastName}`,
                email: email.toLowerCase(),
                contact: contact,
                firstName,
                lastName,
                membershipType: "gym",
                membershipDuration: "1",
                status: "pending",
                dateOfMembership: new Date().toISOString(),
                date: new Date().toISOString(),
                paymentMethod: "Cash",
                paymentStatus: "pending",
                pin: verificationPin,
                verified: false,
                password,
              };

              // Get existing registrations
              const registrations = JSON.parse(
                localStorage.getItem("registrations") || "[]"
              );

              // Add to registrations
              registrations.push(registrationData);
              localStorage.setItem(
                "registrations",
                JSON.stringify(registrations)
              );

              // Show PIN to user and open verification modal
              alert(
                `Your PIN is: ${verificationPin}\nPlease remember this PIN for verification.`
              );
              openPinVerificationModal();
            } catch (error) {
              console.error("Registration error:", error);
              errorElement.textContent =
                "Registration failed. Please try again.";
              errorElement.classList.remove("hidden");
            }
          });
        }

        // Reset checkbox error on checkbox change
        document
          .getElementById("agreeTerms")
          ?.addEventListener("change", function () {
            document.getElementById("checkbox-error").classList.add("hidden");
            document
              .getElementById("terms-checkbox-container")
              .classList.remove("checkbox-error");
          });
      });
    </script>
  </body>
</html>
